name: Executar Script Cliente TROPA

on:
  schedule:
    - cron: "0 10 * * *"  # Executa todos os dias √†s 10:00 UTC (07:00 no Brasil)
  workflow_dispatch:  # Permite rodar manualmente

jobs:
  executar-script-tropa:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Clonar Reposit√≥rio
        uses: actions/checkout@v3

      - name: ‚öôÔ∏è Configurar Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.11"

      - name: üì¶ Instalar Depend√™ncias
        run: pip install -r requirements.txt

      # üîç Valida√ß√£o antes da execu√ß√£o
      - name: üõ†Ô∏è Verificar JSON das Credenciais
        run: |
          if [ -z "${{ secrets.GOOGLE_CREDENTIALS_TROPA }}" ]; then
            echo "‚ùå Erro: Secret GOOGLE_CREDENTIALS_TROPA n√£o est√° definido!" && exit 1
          else
            echo "‚úÖ Secret GOOGLE_CREDENTIALS_TROPA carregado com sucesso!"
          fi

      - name: üîë Criar arquivo de credenciais do Google
        run: |
          printf '%s' '${{ secrets.GOOGLE_CREDENTIALS_TROPA }}' > automacao-meta-ads.json
          sed -i 's/\\n/\n/g' automacao-meta-ads.json  # Corrige quebras de linha
          cat automacao-meta-ads.json | python -m json.tool || exit 1  # Valida o JSON

          if [ ! -s automacao-meta-ads.json ]; then
            echo "‚ùå ERRO: O arquivo de credenciais n√£o foi criado corretamente!" && exit 1
          else
            echo "‚úÖ Arquivo de credenciais criado e validado!"
          fi

      # ‚úÖ **Execu√ß√£o do Script**
      - name: üöÄ Executar Script Cliente TROPA
        env:
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID_TROPA }}
          GOOGLE_SHEET_TAB: ${{ secrets.GOOGLE_SHEET_TAB_TROPA }}
          META_ACCESS_TOKEN: ${{ secrets.META_ACCESS_TOKEN_TROPA }}
          LOG_EXECUTION: ${{ secrets.LOG_EXECUTION_TROPA }}
        run: python clientes/CA_TROPA/script_tropa.py

      - name: üìù Salvar logs como artefato
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-tropa
          path: logs.txt

      # üîÑ **Sincronizar logs com o GitHub**
      - name: üîÑ Configurar autentica√ß√£o do GitHub
        if: always()
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          echo "machine github.com login oauth2 password ${{ secrets.GH_TOKEN }}" > ~/.netrc

      - name: üì§ Registrar Log no GitHub
        if: always()
        run: |
          git pull origin main --rebase || echo "‚ö†Ô∏è Nenhuma atualiza√ß√£o encontrada no reposit√≥rio"
          echo "$(date) - Cliente TROPA - Workflow finalizado." >> logs.txt
          git add logs.txt
          git commit -m "Atualiza logs de execu√ß√£o TROPA" || echo "‚ö†Ô∏è Nenhuma altera√ß√£o para commit"
          git push https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/EduardoGestor/automacao-meta-ads.git main || echo "‚ö†Ô∏è Falha ao enviar para o reposit√≥rio"
